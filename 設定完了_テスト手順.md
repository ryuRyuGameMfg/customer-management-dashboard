# Discord Webhook 設定完了

## ✅ 設定済み

以下が設定されました：

1. **Discord Webhook URL**: `https://discord.com/api/webhooks/1435795248138813472/nqM0zJlYlIAVYjdZPtV5fRrB7MVMVOJcDwlAM8DV6ZejCUsHdbcEddD2jHd2mS9OhwW2`
2. **環境変数**: `.env.local`ファイルに保存済み
3. **API Route**: `/api/notifications/check` が実装済み
4. **Vercel Cron**: 毎日UTC 0時（日本時間9時）に自動実行

## 🧪 テスト方法

### 1. 開発サーバーを起動
```bash
cd next-app
npm run dev
```

### 2. テストモードで実行（通知を送信しない）
ブラウザで以下を開く：
```
http://localhost:3000/api/notifications/check?test=true
```

または、ターミナルで：
```bash
curl http://localhost:3000/api/notifications/check?test=true
```

### 3. 実際にDiscordに通知を送信（テスト）
ブラウザで以下を開く：
```
http://localhost:3000/api/notifications/check
```

または、ターミナルで：
```bash
curl http://localhost:3000/api/notifications/check
```

## 📅 定期実行の設定

`vercel.json`で毎日UTC 0時（日本時間9時）に自動実行されるように設定されています。

### スケジュールを変更したい場合

`next-app/vercel.json`を編集：
- `"0 0 * * *"` = 毎日0時（UTC）= 日本時間9時 ← 現在の設定
- `"0 9 * * *"` = 毎日9時（UTC）= 日本時間18時
- `"0 0 * * 1-5"` = 平日のみ（月〜金）

## 🚀 Vercelにデプロイする場合

### 1. Vercelダッシュボードで環境変数を設定
1. Vercelダッシュボードにログイン
2. プロジェクトを選択
3. **Settings** → **Environment Variables**
4. 以下を追加：
   - **Name**: `DISCORD_WEBHOOK_URL`
   - **Value**: `https://discord.com/api/webhooks/1435795248138813472/nqM0zJlYlIAVYjdZPtV5fRrB7MVMVOJcDwlAM8DV6ZejCUsHdbcEddD2jHd2mS9OhwW2`
   - **Environment**: Production, Preview, Development（すべてにチェック）

### 2. デプロイ
```bash
git add .
git commit -m "Add Discord notification feature"
git push
```

または：
```bash
vercel
```

## 📋 通知内容

以下の条件に該当する顧客が通知されます：

1. **実行予定日が今日または明日の顧客**
   - `scheduledDate`フィールドが設定されている場合

2. **最終連絡日から一定期間経過した顧客**
   - `nextAction`が「リコンタクト」→ 最終連絡から4日以上経過
   - `nextAction`が「フォローアップ」→ 最終連絡から6日以上経過

3. **アクションが「完了」以外の顧客**

通知は優先度順にソートされ、以下の情報が含まれます：
- 顧客名
- 次のアクション
- 実行予定日
- 最終連絡日
- 連絡先
- 総額

## ⚠️ 注意事項

- Webhook URLは秘密情報です。GitHubにコミットされないよう注意してください（`.env.local`は既に`.gitignore`に登録済み）
- Vercelにデプロイする場合は、必ず環境変数を設定してください
- テストモード（`?test=true`）では実際にDiscordに通知を送信しません

## 🔧 トラブルシューティング

### 通知が来ない場合
1. Webhook URLが正しいか確認
2. 今日対応すべき顧客がいるか確認（`?test=true`で確認）
3. Discordチャンネルの設定を確認
4. サーバーログを確認

### エラーが発生する場合
1. `.env.local`ファイルが`next-app`フォルダ内にあるか確認
2. 開発サーバーを再起動
3. エラーメッセージを確認

